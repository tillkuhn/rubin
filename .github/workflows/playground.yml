# this is our action playground which is triggered whenever this file is changes
name: playground

on:
  push:
    paths: [ '.github/workflows/playground.yml' ]

env:
  KAFKA_TOPIC: ci.events

jobs:
  test:
    name: Come out and test
    runs-on: ubuntu-latest
    steps:
      - name: Install latest rubin Kafka Record producer
        run: |
          curl -LsSo ${{ runner.temp }}/rubin.zip $(curl -LsS 'https://api.github.com/repos/tillkuhn/rubin/releases/latest' | jq -r '.assets[] | select(.name|endswith("linux_amd64.zip")).browser_download_url')
          unzip ${{ runner.temp }}/rubin.zip -d ${{ runner.temp }} && chmod u+g ${{ runner.temp }}/rubin
      - name: Test Kafka Messaging
        # GitHub vars: https://dev.to/mihinduranasinghe/working-with-environment-variables-github-actions-part-2-46po
        # https://stackoverflow.com/questions/59073850/github-actions-get-url-of-test-build
        # GITHUB_REPOSITORY=<github-org>/rubin GITHUB_WORKFLOW=playground (w/o .yml)
        run: |
          ${{ runner.temp }}/rubin -key "${GITHUB_REPOSITORY}/${GITHUB_RUN_ID}" -ce \
          -source "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
          -type "net.timafe.events.ci.published.v1" -subject "$GITHUB_REPOSITORY" \
          -record "{\"action\":\"$GITHUB_ACTION\",\"version\":\"${GITHUB_REF#refs/*/}\",\"commit\":\"$GITHUB_SHA\"}" \
          -header "workflow=$GITHUB_WORKFLOW"
        env:
          # shared with HCP Vault
          KAFKA_PRODUCER_TOPIC_URL: ${{ secrets.KAFKA_PRODUCER_TOPIC_URL }}
          KAFKA_PRODUCER_API_SECRET: ${{ secrets.KAFKA_PRODUCER_API_SECRET }}
