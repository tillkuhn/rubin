# this is our action playground which is triggered whenever this file is changes
name: playground

on:
  push:
    paths: [ '.github/workflows/playground.yml' ]

env:
  KAFKA_TOPIC: ci.events

jobs:
  test:
    name: Come out and play
    runs-on: ubuntu-latest
    steps:
      - name: Install latest rubin Kafka Record producer
        run: |
          curl -LsSo ${{ runner.temp }}/rubin.zip $(curl -LsS 'https://api.github.com/repos/tillkuhn/rubin/releases/latest' | jq -r '.assets[] | select(.name|endswith("linux_amd64.zip")).browser_download_url')
          unzip ${{ runner.temp }}/rubin.zip -d ${{ runner.temp }} && chmod u+g ${{ runner.temp }}/rubin
      - name: Test Kafka Messaging
        # GitHub vars: https://dev.to/mihinduranasinghe/working-with-environment-variables-github-actions-part-2-46po
        # https://stackoverflow.com/questions/59073850/github-actions-get-url-of-test-build
        run: |
          ${{ runner.temp }}/rubin -topic "$KAFKA_TOPIC" -key "$GITHUB_RUN_ID" -ce \
          -source "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
          -type "com.github.artifact.released" \
          -subject "rubin_0.1.4_darwin_amd64.zip" \
          -record "{\"action\":\"deploy-api\",\"repo\":\"$GITHUB_REPOSITORY\"}" \
          -header "commit=$GITHUB_SHA" -header "workflow=$GITHUB_WORKFLOW" -header "type=cloudevents"
        env:
          # shared with HCP Vault
          KAFKA_REST_ENDPOINT: ${{ secrets.KAFKA_REST_ENDPOINT }}
          KAFKA_CLUSTER_ID: ${{ secrets.KAFKA_CLUSTER_ID }}
          KAFKA_PRODUCER_API_KEY: ${{ secrets.KAFKA_PRODUCER_API_KEY }}
          KAFKA_PRODUCER_API_SECRET: ${{ secrets.KAFKA_PRODUCER_API_SECRET }}
